name: Build & Release Executable

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*' # Esegue la build solo quando pusho un tag (es. v1.0)

permissions:
  contents: write # FONDAMENTALE: Serve per permettere all'action di creare la Release

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout del codice
      uses: actions/checkout@v4

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 9.0.x

    - name: Ripristina dipendenze
      run: dotnet restore

    - name: Pubblica (Native AOT)
      # Nota: Ho cambiato l'output in ./publish come richiesto
      run: |
        dotnet publish -c Release -r win-x64 --self-contained -p:PublishAot=true -p:PublishTrimmed=true -p:TrimMode=link -p:PublishSingleFile=true -p:StripSymbols=true -o ./publish

    # (Opzionale) Rinomina l'exe per includere la versione o pulire il nome
    # - name: Rinomina Eseguibile
    #   run: ren ./publish/MuteMe.exe MuteMe_App.exe

    # 1. Carica come Artefatto (GitHub lo zipperà comunque nella UI "Actions")
    - name: Upload Artifact (Internal)
      uses: actions/upload-artifact@v4
      with:
        name: MuteMe-Artifact
        path: ./publish/MuteMe.exe 
        # Puntando al file specifico, lo zip conterrà solo l'exe senza cartelle

    # 2. Crea una RELEASE (Qui scarichi l'EXE vero e proprio!)
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: ./publish/MuteMe.exe
        draft: false
        prerelease: false
        # Nota: Questo step caricherà MuteMe.exe nella sezione "Releases" a destra del tuo repo.